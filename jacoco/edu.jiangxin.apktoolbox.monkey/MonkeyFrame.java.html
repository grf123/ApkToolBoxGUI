<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MonkeyFrame.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">APKToolBoxGUI</a> &gt; <a href="index.source.html" class="el_package">edu.jiangxin.apktoolbox.monkey</a> &gt; <span class="el_source">MonkeyFrame.java</span></div><h1>MonkeyFrame.java</h1><pre class="source lang-java linenums">package edu.jiangxin.apktoolbox.monkey;

import java.awt.Container;
import java.awt.Label;
import java.awt.Toolkit;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.List;
import java.util.Vector;

import javax.swing.ButtonGroup;
import javax.swing.ComboBoxModel;
import javax.swing.DefaultComboBoxModel;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JDialog;
import javax.swing.JFileChooser;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JRadioButton;
import javax.swing.JTextField;
import javax.swing.WindowConstants;

import edu.jiangxin.apktoolbox.swing.extend.JEasyFrame;
import edu.jiangxin.apktoolbox.utils.Utils;

public class MonkeyFrame extends JEasyFrame {

	private static final long serialVersionUID = 1L;

<span class="nc" id="L39">	Thread threadTimeType = null;</span>
<span class="nc" id="L40">	Thread threadMonkey = null;</span>

<span class="nc" id="L42">	JPanel panel = new JPanel();</span>
<span class="nc" id="L43">	JFileChooser fileChooser = new JFileChooser();</span>
<span class="nc" id="L44">	JButton logPathButton = new JButton(&quot;选择路径&quot;);</span>
<span class="nc" id="L45">	JButton excuteButton = new JButton(&quot;运行命令&quot;);</span>
<span class="nc" id="L46">	JButton refreshButton = new JButton(&quot;刷新&quot;);</span>
<span class="nc" id="L47">	JButton resetButton = new JButton(&quot;重置页面&quot;);</span>
<span class="nc" id="L48">	JButton interruptButton = new JButton(&quot;终止运行&quot;);</span>
<span class="nc" id="L49">	JButton exitButton = new JButton(&quot;退出运行&quot;);</span>
<span class="nc" id="L50">	JLabel labelDevices = new JLabel(&quot;设备列表&quot;);</span>
<span class="nc" id="L51">	JLabel labelProgram = new JLabel(&quot;应用程序&quot;);</span>
<span class="nc" id="L52">	JLabel labelSpace = new JLabel(&quot;事件间隔&quot;);</span>
<span class="nc" id="L53">	JLabel labelMillisecond = new JLabel(&quot;毫秒&quot;);</span>
<span class="nc" id="L54">	JLabel labelTime = new JLabel(&quot;运行时长&quot;);</span>
<span class="nc" id="L55">	JLabel labelLogLevel = new JLabel(&quot;日志级别&quot;);</span>
<span class="nc" id="L56">	JLabel labelRestrain = new JLabel(&quot;约束条件&quot;);</span>
<span class="nc" id="L57">	JLabel labelHour = new JLabel();</span>
<span class="nc" id="L58">	JLabel labelMinute = new JLabel();</span>
<span class="nc" id="L59">	JLabel labelSecond = new JLabel();</span>
<span class="nc" id="L60">	JTextField textMillisecond = new JTextField(30);</span>
<span class="nc" id="L61">	JTextField textTime = new JTextField(30);</span>
<span class="nc" id="L62">	JTextField textLogPath = new JTextField(90);</span>
<span class="nc" id="L63">	JComboBox comboBoxDevices = new JComboBox();</span>
<span class="nc" id="L64">	JComboBox comboBoxProgram = new JComboBox();</span>
<span class="nc" id="L65">	JComboBox comboBoxTime = new JComboBox();</span>
	// --dbg-no-events：初始化启动的activity，但是不产生任何事件
<span class="nc" id="L67">	JCheckBox checkBoxDbgNoEvents = new JCheckBox(&quot;初始化启动的activity，但是不产生任何事件&quot;);</span>
	// --hprof：指定该项后在事件序列发送前后会立即生成分析报告（一般建议指定该项）
<span class="nc" id="L69">	JCheckBox checkBoxHprof = new JCheckBox(&quot;在事件序列发送前后会立即生成分析报告&quot;);</span>
	// --ignore-crashes：忽略崩溃
<span class="nc" id="L71">	JCheckBox checkBoxCrashes = new JCheckBox(&quot;忽略崩溃&quot;, true);</span>
	// --ignore-timeouts：忽略超时
<span class="nc" id="L73">	JCheckBox checkBoxTimeouts = new JCheckBox(&quot;忽略超时&quot;, true);</span>
	// --monitor-native-crashes：跟踪本地方法的崩溃问题
<span class="nc" id="L75">	JCheckBox checkBoxNativeCrashes = new JCheckBox(&quot;跟踪本地方法的崩溃问题&quot;, true);</span>
	// --ignore-security-exceptions：忽略安全异常
<span class="nc" id="L77">	JCheckBox checkBoxExceptions = new JCheckBox(&quot;忽略安全异常&quot;, true);</span>
	// --kill-process-after-error：发生错误后直接杀掉进程
<span class="nc" id="L79">	JCheckBox checkBoxKill = new JCheckBox(&quot;发生错误后直接杀掉进程&quot;);</span>
	// --wait-dbg：知道连接了调试器才执行monkey测试
<span class="nc" id="L81">	JCheckBox checkBoxWaitDbg = new JCheckBox(&quot;停止Monkey执行，直到有调试器与其连接&quot;);</span>

<span class="nc" id="L83">	ButtonGroup group = new ButtonGroup();</span>
<span class="nc" id="L84">	JRadioButton radioButton0 = new JRadioButton(&quot;基本信息&quot;);// 缺省值</span>
<span class="nc" id="L85">	JRadioButton radioButton1 = new JRadioButton(&quot;比较详细&quot;);// 比较详细</span>
<span class="nc" id="L86">	JRadioButton radioButton2 = new JRadioButton(&quot;非常详细&quot;, true);// 非常详细//默认选中</span>

<span class="nc" id="L88">	String dbgNoEvents = &quot;&quot;;</span>
<span class="nc" id="L89">	String hprof = &quot;&quot;;</span>
<span class="nc" id="L90">	String ignoreCrashes = &quot;&quot;;</span>
<span class="nc" id="L91">	String ignoreTimeouts = &quot;&quot;;</span>
<span class="nc" id="L92">	String monitorNativeCrashes = &quot;&quot;;</span>
<span class="nc" id="L93">	String ignoreSecurityExceptions = &quot;&quot;;</span>
<span class="nc" id="L94">	String killProcessAfterError = &quot;&quot;;</span>
<span class="nc" id="L95">	String waitDbg = &quot;&quot;;</span>

<span class="nc" id="L97">	String logLevel = &quot;&quot;;</span>
	ArrayList&lt;String&gt; list;
<span class="nc" id="L99">	ArrayList&lt;String&gt; arrayList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L100">	int flag = 0;</span>
	//	String logFolder = &quot;&quot;;
<span class="nc" id="L102">	String[] monkeyCmd = null;</span>

	public MonkeyFrame() {
<span class="nc" id="L105">		super();</span>
<span class="nc" id="L106">		setTitle(&quot;Monkey Test&quot;);</span>
<span class="nc" id="L107">		add(panel, &quot;Center&quot;);</span>
<span class="nc" id="L108">		setSize(700, 400);</span>
<span class="nc" id="L109">		setResizable(false);</span>

<span class="nc" id="L111">		panel.setLayout(null);</span>
<span class="nc" id="L112">		panel.add(labelDevices);</span>
<span class="nc" id="L113">		panel.add(comboBoxDevices);</span>
<span class="nc" id="L114">		panel.add(refreshButton);</span>

<span class="nc" id="L116">		panel.add(labelProgram);</span>
<span class="nc" id="L117">		panel.add(comboBoxProgram);</span>

<span class="nc" id="L119">		panel.add(labelRestrain);</span>
<span class="nc" id="L120">		panel.add(checkBoxCrashes);</span>
<span class="nc" id="L121">		panel.add(checkBoxTimeouts);</span>
<span class="nc" id="L122">		panel.add(checkBoxExceptions);</span>
<span class="nc" id="L123">		panel.add(checkBoxNativeCrashes);</span>
<span class="nc" id="L124">		panel.add(checkBoxKill);</span>
<span class="nc" id="L125">		panel.add(checkBoxWaitDbg);</span>
<span class="nc" id="L126">		panel.add(checkBoxHprof);</span>

<span class="nc" id="L128">		panel.add(labelSpace);</span>
<span class="nc" id="L129">		panel.add(labelHour);// 时</span>
<span class="nc" id="L130">		panel.add(labelMinute);// 分</span>
<span class="nc" id="L131">		panel.add(labelSecond);// 秒</span>
<span class="nc" id="L132">		panel.add(textMillisecond);</span>
<span class="nc" id="L133">		panel.add(labelMillisecond);</span>

<span class="nc" id="L135">		panel.add(labelTime);</span>
<span class="nc" id="L136">		panel.add(textTime);</span>
<span class="nc" id="L137">		panel.add(comboBoxTime);</span>

<span class="nc" id="L139">		panel.add(labelLogLevel);</span>
<span class="nc" id="L140">		panel.add(radioButton0);</span>
<span class="nc" id="L141">		panel.add(radioButton1);</span>
<span class="nc" id="L142">		panel.add(radioButton2);</span>

<span class="nc" id="L144">		panel.add(logPathButton);</span>
<span class="nc" id="L145">		panel.add(textLogPath);</span>

<span class="nc" id="L147">		panel.add(excuteButton);</span>
<span class="nc" id="L148">		panel.add(resetButton);</span>
<span class="nc" id="L149">		panel.add(interruptButton);</span>
<span class="nc" id="L150">		panel.add(exitButton);</span>

<span class="nc" id="L152">		labelDevices.setBounds(30, 25, 60, 20);</span>
<span class="nc" id="L153">		comboBoxDevices.setBounds(90, 25, 240, 20);</span>
<span class="nc" id="L154">		refreshButton.setBounds(340, 25, 60, 20);</span>

<span class="nc" id="L156">		labelProgram.setBounds(30, 55, 60, 20);</span>
<span class="nc" id="L157">		comboBoxProgram.setBounds(90, 55, 240, 20);</span>
<span class="nc" id="L158">		comboBoxProgram.setEditable(true);</span>
<span class="nc" id="L159">		comboBoxProgram.setSelectedItem(&quot;com.shinow.*&quot;);</span>
<span class="nc" id="L160">		labelRestrain.setBounds(30, 85, 56, 20);</span>

<span class="nc" id="L162">		checkBoxCrashes.setBounds(86, 85, 100, 20);</span>
<span class="nc" id="L163">		checkBoxTimeouts.setBounds(186, 85, 100, 20);</span>
<span class="nc" id="L164">		checkBoxExceptions.setBounds(286, 85, 110, 20);</span>
<span class="nc" id="L165">		checkBoxNativeCrashes.setBounds(400, 85, 180, 20);</span>
<span class="nc" id="L166">		checkBoxKill.setBounds(86, 115, 180, 20);</span>
<span class="nc" id="L167">		checkBoxWaitDbg.setBounds(286, 115, 280, 20);</span>
<span class="nc" id="L168">		checkBoxHprof.setBounds(86, 145, 280, 20);</span>

<span class="nc" id="L170">		labelSpace.setBounds(30, 175, 60, 20);</span>
<span class="nc" id="L171">		textMillisecond.setBounds(90, 175, 150, 20);</span>
<span class="nc" id="L172">		textMillisecond.setDocument(new NumberLenghtLimitedDmt(7));</span>
<span class="nc" id="L173">		textMillisecond.setText(&quot;500&quot;);</span>
<span class="nc" id="L174">		labelMillisecond.setBounds(245, 175, 40, 20);</span>

<span class="nc" id="L176">		labelTime.setBounds(30, 205, 60, 20);</span>
<span class="nc" id="L177">		textTime.setBounds(90, 205, 150, 20);</span>
<span class="nc" id="L178">		textTime.setDocument(new NumberLenghtLimitedDmt(7));</span>
<span class="nc" id="L179">		textTime.setText(&quot;1&quot;);</span>
<span class="nc" id="L180">		comboBoxTime.setBounds(245, 205, 50, 20);</span>
<span class="nc" id="L181">		comboBoxTime.addItem(Common.Hour);</span>
<span class="nc" id="L182">		comboBoxTime.addItem(Common.Minute);</span>
<span class="nc" id="L183">		comboBoxTime.addItem(Common.Second);</span>

<span class="nc" id="L185">		labelHour.setBounds(405, 205, 50, 20);</span>
<span class="nc" id="L186">		labelMinute.setBounds(475, 205, 50, 20);</span>
<span class="nc" id="L187">		labelSecond.setBounds(545, 205, 50, 20);</span>

<span class="nc" id="L189">		labelLogLevel.setBounds(30, 235, 60, 20);</span>

<span class="nc" id="L191">		group.add(radioButton0);</span>
<span class="nc" id="L192">		group.add(radioButton1);</span>
<span class="nc" id="L193">		group.add(radioButton2);</span>

<span class="nc" id="L195">		radioButton0.setBounds(86, 235, 80, 20);</span>
<span class="nc" id="L196">		radioButton1.setBounds(186, 235, 80, 20);</span>
<span class="nc" id="L197">		radioButton2.setBounds(286, 235, 80, 20);</span>

<span class="nc" id="L199">		logPathButton.setBounds(30, 265, 100, 20);</span>
<span class="nc" id="L200">		textLogPath.setBounds(140, 265, 320, 20);</span>
<span class="nc" id="L201">		textLogPath.setEditable(false);</span>
<span class="nc" id="L202">		textLogPath.setText(&quot;D:&quot;);</span>

<span class="nc" id="L204">		excuteButton.setBounds(30, 305, 100, 20);</span>
<span class="nc" id="L205">		resetButton.setBounds(140, 305, 100, 20);</span>
<span class="nc" id="L206">		interruptButton.setBounds(250, 305, 100, 20);</span>
<span class="nc" id="L207">		exitButton.setBounds(360, 305, 100, 20);</span>

<span class="nc" id="L209">		interruptButton.setEnabled(false);</span>

<span class="nc" id="L211">		registListener();</span>

<span class="nc" id="L213">	}</span>

	/**
	 * 运行
	 */
	private void registListener() {

<span class="nc" id="L220">		logPathButton.addActionListener(new ActionListener() {</span>

			/**
			 * 弹出窗体，选择文件夹
			 */
			@Override
			public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L227" title="All 2 branches missed.">				if (e.getSource() == logPathButton) {</span>
<span class="nc" id="L228">					fileChooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);</span>
<span class="nc" id="L229">					int intRetVal = fileChooser.showOpenDialog(new Label());</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">					if (intRetVal == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L231">						textLogPath.setText(fileChooser.getSelectedFile().getPath());</span>
					}
				}

<span class="nc" id="L235">			}</span>
		});

		/**
		 * 刷新按钮点击时间监听
		 */
<span class="nc" id="L241">		refreshButton.addActionListener(new ActionListener() {</span>

			public void actionPerformed(ActionEvent e) {

				// 从项列表中移除所有项
<span class="nc" id="L246">				comboBoxDevices.removeAllItems();</span>

				// 执行Dos命令获取设备列表
<span class="nc" id="L249">				getDevices(Common.CMD_Devices);</span>

<span class="nc" id="L251">			}</span>

		});

		/**
		 * 下拉框点击事件监听
		 */
<span class="nc" id="L258">		comboBoxDevices.addActionListener(new ActionListener() {</span>

			public void actionPerformed(ActionEvent e) {

				// 从项列表中移除所有项
<span class="nc" id="L263">				comboBoxProgram.removeAllItems();</span>
<span class="nc" id="L264">				comboBoxProgram.setSelectedItem(&quot;com.shinow.*&quot;);</span>
				// 选择设备，自动加载对应的应用程序列表，并在应用程序下拉框中显示
<span class="nc" id="L266">				getProgram(Common.CMD_Program_A + comboBoxDevices.getSelectedItem() + Common.CMD_Program_B);</span>

<span class="nc" id="L268">			}</span>

		});

		/**
		 *运行命令监听
		 */
<span class="nc" id="L275">		excuteButton.addActionListener(new ActionListener() {</span>

			public void actionPerformed(ActionEvent e) {

				// 获取约束条件
<span class="nc bnc" id="L280" title="All 2 branches missed.">				if (checkBoxCrashes.isSelected()) {</span>
<span class="nc" id="L281">					ignoreCrashes = Common.Ignore_Crashes;</span>
				}
<span class="nc bnc" id="L283" title="All 2 branches missed.">				if (checkBoxTimeouts.isSelected()) {</span>
<span class="nc" id="L284">					ignoreTimeouts = Common.Ignore_Timeouts;</span>
				}
<span class="nc bnc" id="L286" title="All 2 branches missed.">				if (checkBoxNativeCrashes.isSelected()) {</span>
<span class="nc" id="L287">					monitorNativeCrashes = Common.Monitor_Native_Crashes;</span>
				}
<span class="nc bnc" id="L289" title="All 2 branches missed.">				if (checkBoxExceptions.isSelected()) {</span>
<span class="nc" id="L290">					ignoreSecurityExceptions = Common.Ignore_Security_Exceptions;</span>
				}
<span class="nc bnc" id="L292" title="All 2 branches missed.">				if (checkBoxHprof.isSelected()) {</span>
<span class="nc" id="L293">					hprof = Common.Hprof;</span>
				}
<span class="nc bnc" id="L295" title="All 2 branches missed.">				if (checkBoxKill.isSelected()) {</span>
<span class="nc" id="L296">					killProcessAfterError = Common.Kill_Process_After_Error;</span>
				}
<span class="nc bnc" id="L298" title="All 2 branches missed.">				if (checkBoxWaitDbg.isSelected()) {</span>
<span class="nc" id="L299">					waitDbg = Common.Wait_Dbg;</span>
				}

				//自定义参数，是否能够执行Monkey？[0不可以][1可以]
<span class="nc" id="L303">				int start = 0;</span>

				// 判断设备列表和应用程序是否为空
<span class="nc bnc" id="L306" title="All 2 branches missed.">				if (comboBoxDevices.getItemCount() == 0) {</span>
<span class="nc" id="L307">					new Dialog2(Common.Msg4).dialog2.setVisible(true);// 弹出对话框</span>
<span class="nc" id="L308">					refreshButton.requestFocus();</span>
				} else {
<span class="nc bnc" id="L310" title="All 2 branches missed.">					if (comboBoxProgram.getItemCount() == 0) {</span>
<span class="nc" id="L311">						new Dialog2(Common.Msg5).dialog2.setVisible(true);// 弹出对话框</span>
					} else {
						// 判断事件间隔和运行时长是否为空
<span class="nc bnc" id="L314" title="All 2 branches missed.">						if (textMillisecond.getText().length() == 0) {</span>
<span class="nc" id="L315">							new Dialog2(Common.Msg2).dialog2.setVisible(true);// 弹出对话框</span>
<span class="nc" id="L316">							textMillisecond.requestFocus();</span>
						} else {
<span class="nc bnc" id="L318" title="All 2 branches missed.">							if (textTime.getText().length() == 0) {</span>
<span class="nc" id="L319">								new Dialog2(Common.Msg2).dialog2.setVisible(true);// 弹出对话框</span>
<span class="nc" id="L320">								textTime.requestFocus();</span>
							} else {
<span class="nc bnc" id="L322" title="All 2 branches missed.">								if (textLogPath.getText().length() == 0) {</span>
<span class="nc" id="L323">									new Dialog2(Common.Msg6).dialog2.setVisible(true);// 弹出对话框</span>
<span class="nc" id="L324">									logPathButton.requestFocus();</span>
								} else {
<span class="nc" id="L326">									start = 1;</span>
								}
							}
						}
					}
				}

				// 获取日志级别
<span class="nc bnc" id="L334" title="All 2 branches missed.">				if (radioButton0.isSelected()) {</span>
<span class="nc" id="L335">					logLevel = Common.Level_0;</span>
				}
<span class="nc bnc" id="L337" title="All 2 branches missed.">				if (radioButton1.isSelected()) {</span>
<span class="nc" id="L338">					logLevel = Common.Level_1;</span>
				}
<span class="nc bnc" id="L340" title="All 2 branches missed.">				if (radioButton2.isSelected()) {</span>
<span class="nc" id="L341">					logLevel = Common.Level_2;</span>
				}

<span class="nc bnc" id="L344" title="All 2 branches missed.">				if (start == 1) {</span>

					// 日志文件路径
<span class="nc" id="L347">					String logFile = textLogPath.getText() + &quot;\\&quot; + Common.Log_name + Utils.getCurrentDateString() + &quot;.txt&quot;;</span>

					//					logFolder = textLogPath.getText();

					//textLogPath.setText(logFile);

					// Dos执行命令
<span class="nc" id="L354">					monkeyCmd = new String[] { &quot;cmd.exe&quot;, &quot;/C&quot;,</span>
<span class="nc" id="L355">							&quot;adb -s &quot; + comboBoxDevices.getSelectedItem() + &quot; shell monkey -p &quot;</span>
<span class="nc" id="L356">									+ comboBoxProgram.getSelectedItem() + &quot;&quot; + ignoreCrashes + &quot;&quot; + ignoreTimeouts + &quot;&quot;</span>
									+ ignoreSecurityExceptions + &quot;&quot; + monitorNativeCrashes + &quot; --throttle &quot;
<span class="nc" id="L358">									+ textMillisecond.getText() + &quot;&quot; + logLevel + &quot;&quot; + Common.TransactionCount + &quot; &gt; &quot;</span>
									+ logFile };

<span class="nc" id="L361">					logger.info(&quot;Monkey:&quot; + monkeyCmd[2]);</span>

<span class="nc" id="L363">					flag = 0;</span>

					// 执行
					// new Thread(new CmdThread(monkeyCmd)).start();
<span class="nc" id="L367">					threadMonkey = new Thread(new ThreadExcuteMonkey(monkeyCmd));</span>
<span class="nc" id="L368">					threadMonkey.start();</span>

<span class="nc" id="L370">					excuteButton.setEnabled(false);</span>
<span class="nc" id="L371">					resetButton.setEnabled(false);</span>
<span class="nc" id="L372">					interruptButton.setEnabled(true);</span>
<span class="nc" id="L373">					exitButton.setEnabled(false);</span>

					//倒计时文本
<span class="nc" id="L376">					labelHour.setVisible(true);</span>
<span class="nc" id="L377">					labelMinute.setVisible(true);</span>
<span class="nc" id="L378">					labelSecond.setVisible(true);</span>

					// 获取时间类型
<span class="nc" id="L381">					String timeType = (String) comboBoxTime.getSelectedItem();</span>

<span class="nc" id="L383">					long time = Long.parseLong(textTime.getText());</span>

<span class="nc bnc" id="L385" title="All 2 branches missed.">					if (timeType == Common.Hour) {</span>
						// new Thread(new MyThread(time * 3600)).start();
<span class="nc" id="L387">						threadTimeType = new Thread(new ThreadExcuteTime(time * 3600));</span>
<span class="nc" id="L388">						threadTimeType.start();</span>
					}
<span class="nc bnc" id="L390" title="All 2 branches missed.">					if (timeType == Common.Minute) {</span>
						// new Thread(new MyThread(time * 60)).start();
<span class="nc" id="L392">						threadTimeType = new Thread(new ThreadExcuteTime(time * 60));</span>
<span class="nc" id="L393">						threadTimeType.start();</span>
					}
<span class="nc bnc" id="L395" title="All 2 branches missed.">					if (timeType == Common.Second) {</span>
						// new Thread(new MyThread(time)).start();
<span class="nc" id="L397">						threadTimeType = new Thread(new ThreadExcuteTime(time));</span>
<span class="nc" id="L398">						threadTimeType.start();</span>
					}

				}

<span class="nc" id="L403">			}</span>

		});

		/**
		 * 重置页面监听
		 */
<span class="nc" id="L410">		resetButton.addActionListener(new ActionListener() {</span>

			public void actionPerformed(ActionEvent e) {

				// 重置约束条件
<span class="nc" id="L415">				checkBoxCrashes.setSelected(true);</span>
<span class="nc" id="L416">				checkBoxTimeouts.setSelected(true);</span>
<span class="nc" id="L417">				checkBoxExceptions.setSelected(true);</span>
<span class="nc" id="L418">				checkBoxNativeCrashes.setSelected(true);</span>

				// 重置日志级别
<span class="nc" id="L421">				radioButton0.setSelected(false);</span>
<span class="nc" id="L422">				radioButton1.setSelected(false);</span>
<span class="nc" id="L423">				radioButton2.setSelected(true);</span>

				// 重置事件间隔
<span class="nc" id="L426">				textMillisecond.setText(&quot;500&quot;);</span>

				// 重置运行时长
<span class="nc" id="L429">				textTime.setText(&quot;1&quot;);</span>

<span class="nc" id="L431">			}</span>

		});

		/**
		 * 中断操作监听
		 */
<span class="nc" id="L438">		interruptButton.addActionListener(new ActionListener() {</span>

			public void actionPerformed(ActionEvent e) {

				// 杀掉Monkey执行进程
<span class="nc" id="L443">				interruptThread();</span>

<span class="nc" id="L445">				excuteButton.setEnabled(true);</span>
<span class="nc" id="L446">				resetButton.setEnabled(true);</span>
<span class="nc" id="L447">				interruptButton.setEnabled(false);</span>
<span class="nc" id="L448">				exitButton.setEnabled(true);</span>

<span class="nc" id="L450">				System.gc();</span>

<span class="nc" id="L452">			}</span>

		});

		/**
		 * 退出
		 */

<span class="nc" id="L460">		exitButton.addActionListener(new ActionListener() {</span>

			public void actionPerformed(ActionEvent e) {

<span class="nc" id="L464">				logger.info(&quot;已退出系统（Exit）&quot;);</span>

<span class="nc" id="L466">				System.exit(0);</span>

				//如果虚拟机因崩溃等问题造成关闭，进程中会少2条adb.exe

<span class="nc" id="L470">			}</span>

		});

		/**
		 * 是否忽略崩溃
		 */
<span class="nc" id="L477">		checkBoxCrashes.addItemListener(new ItemListener() {</span>

			public void itemStateChanged(ItemEvent e) {

<span class="nc bnc" id="L481" title="All 2 branches missed.">				if (e.getStateChange() == ItemEvent.SELECTED)</span>

<span class="nc" id="L483">					ignoreCrashes = Common.Ignore_Crashes;</span>

				else

<span class="nc" id="L487">					ignoreCrashes = &quot;&quot;;</span>

<span class="nc" id="L489">			}</span>

		});

		/**
		 * 是否忽略超时
		 */
<span class="nc" id="L496">		checkBoxTimeouts.addItemListener(new ItemListener() {</span>

			public void itemStateChanged(ItemEvent e) {

<span class="nc bnc" id="L500" title="All 2 branches missed.">				if (e.getStateChange() == ItemEvent.SELECTED)</span>

<span class="nc" id="L502">					ignoreTimeouts = Common.Ignore_Timeouts;</span>

				else

<span class="nc" id="L506">					ignoreTimeouts = &quot;&quot;;</span>

<span class="nc" id="L508">			}</span>

		});

		/**
		 * 是否跟踪本地方法的崩溃问题
		 */
<span class="nc" id="L515">		checkBoxExceptions.addItemListener(new ItemListener() {</span>

			public void itemStateChanged(ItemEvent e) {

<span class="nc bnc" id="L519" title="All 2 branches missed.">				if (e.getStateChange() == ItemEvent.SELECTED)</span>

<span class="nc" id="L521">					ignoreSecurityExceptions = Common.Ignore_Security_Exceptions;</span>

				else

<span class="nc" id="L525">					ignoreSecurityExceptions = &quot;&quot;;</span>

<span class="nc" id="L527">			}</span>

		});

		/**
		 * 是否忽略安全异常
		 */
<span class="nc" id="L534">		checkBoxNativeCrashes.addItemListener(new ItemListener() {</span>

			public void itemStateChanged(ItemEvent e) {

<span class="nc bnc" id="L538" title="All 2 branches missed.">				if (e.getStateChange() == ItemEvent.SELECTED)</span>

<span class="nc" id="L540">					monitorNativeCrashes = Common.Monitor_Native_Crashes;</span>

				else

<span class="nc" id="L544">					monitorNativeCrashes = &quot;&quot;;</span>

<span class="nc" id="L546">			}</span>

		});

<span class="nc" id="L550">	}</span>

	/**
	 * 中断Monkey命令
	 */
	public void interruptThread() {

<span class="nc" id="L557">		logger.info(&quot;中断Monkey命令--开始&quot;);</span>

<span class="nc" id="L559">		String[] cmd1 = new String[] { &quot;cmd.exe&quot;, &quot;/c&quot;,</span>
<span class="nc" id="L560">				Common.CMD_PS_A + comboBoxDevices.getSelectedItem() + Common.CMD_PS_B };</span>
<span class="nc" id="L561">		excuteCommand(cmd1, Common.Monkey);</span>

<span class="nc" id="L563">		List&lt;String&gt; listPid = list;</span>
<span class="nc" id="L564">		logger.info(&quot;获取的中断Monkey进程数量：&quot; + listPid.size());</span>

<span class="nc" id="L566">		String[] cmd2 = null;</span>
<span class="nc" id="L567">		String pid = &quot;&quot;;</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">		for (int i = 0; i &lt; listPid.size(); i++) {</span>
<span class="nc" id="L569">			pid = listPid.get(i);</span>
<span class="nc" id="L570">			cmd2 = new String[] { &quot;cmd.exe&quot;, &quot;/c&quot;,</span>
<span class="nc" id="L571">					Common.CMD_Kill_A + comboBoxDevices.getSelectedItem() + Common.CMD_Kill_B + pid };</span>
<span class="nc" id="L572">			excuteCommand(cmd2, Common.Monkey);</span>
		}

<span class="nc" id="L575">		flag = 1;</span>

		// threadTimeType.interrupt();
<span class="nc" id="L578">		threadMonkey.interrupt();</span>

<span class="nc" id="L580">		labelHour.setVisible(false);</span>
<span class="nc" id="L581">		labelMinute.setVisible(false);</span>
<span class="nc" id="L582">		labelSecond.setVisible(false);</span>

<span class="nc" id="L584">		logger.info(&quot;中断Monkey命令--结束&quot;);</span>

<span class="nc" id="L586">	}</span>

	/**
	 * 获取设备列表
	 * 
	 * @param cmd
	 */
	public void getDevices(String cmd) {

<span class="nc" id="L595">		logger.info(&quot;获取设备列表......开始&quot;);</span>

		try {
<span class="nc" id="L598">			Process process = Runtime.getRuntime().exec(cmd);</span>

<span class="nc" id="L600">			BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));</span>

<span class="nc" id="L602">			String line = null;</span>

<span class="nc bnc" id="L604" title="All 2 branches missed.">			while ((line = reader.readLine()) != null) {</span>

<span class="nc bnc" id="L606" title="All 4 branches missed.">				if (line.indexOf(&quot;List&quot;) &lt; 0 &amp;&amp; line.length() != 0) {</span>

<span class="nc" id="L608">					line = line.substring(0, line.length() - 7);</span>

<span class="nc" id="L610">					logger.info(&quot;获取的设备名称：&quot; + line);</span>

<span class="nc" id="L612">					comboBoxDevices.addItem(line);</span>

				}

			}

			// process.waitFor();

<span class="nc" id="L620">			process.getOutputStream().close(); // 不要忘记了一定要关</span>

<span class="nc" id="L622">		} catch (Exception e) {</span>

<span class="nc" id="L624">			logger.error(&quot;获取设备列表异常&quot;, e);</span>

<span class="nc" id="L626">		}</span>

<span class="nc" id="L628">		logger.info(&quot;获取设备列表......结束&quot;);</span>

<span class="nc" id="L630">	}</span>

	/**
	 * 获取应用程序列表
	 * 
	 * @param cmd
	 */
	public void getProgram(String cmd) {

<span class="nc" id="L639">		logger.info(&quot;获取应用程序列表......开始&quot;);</span>

		try {
<span class="nc" id="L642">			Process process = Runtime.getRuntime().exec(cmd);</span>

<span class="nc" id="L644">			BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));</span>

<span class="nc" id="L646">			String line = null;</span>

<span class="nc bnc" id="L648" title="All 2 branches missed.">			while ((line = reader.readLine()) != null) {</span>

				//if (line.indexOf(Common.Shinow) &gt;= 0 &amp;&amp; line.length() != 0) {

<span class="nc" id="L652">				logger.info(&quot;获取应用程序名称：&quot; + line);</span>

<span class="nc" id="L654">				comboBoxProgram.addItem(line);</span>

				//}

			}

			// process.waitFor();

<span class="nc" id="L662">			process.getOutputStream().close(); // 不要忘记了一定要关</span>

<span class="nc" id="L664">		} catch (Exception e) {</span>

<span class="nc" id="L666">			logger.error(&quot;获取应用程序列表异常&quot;, e);</span>

<span class="nc" id="L668">		}</span>

<span class="nc" id="L670">		logger.info(&quot;获取应用程序列表......结束&quot;);</span>

<span class="nc" id="L672">	}</span>

	/**
	 * 运行Dos命令
	 * @param cmd	命令
	 * @param keyValue	关键字
	 */
	public void excuteCommand(String[] cmd, String keyValue) {

<span class="nc" id="L681">		logger.info(&quot;运行Dos命令......开始&quot;);</span>

<span class="nc" id="L683">		list = new ArrayList&lt;String&gt;();</span>

		try {

<span class="nc" id="L687">			Process process = Runtime.getRuntime().exec(cmd);</span>

<span class="nc" id="L689">			BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));</span>

<span class="nc" id="L691">			String line = null;</span>

<span class="nc bnc" id="L693" title="All 2 branches missed.">			while ((line = reader.readLine()) != null) {</span>

<span class="nc bnc" id="L695" title="All 2 branches missed.">				if (line.indexOf(keyValue) &gt;= 0) {</span>

<span class="nc" id="L697">					line = line.replace(&quot; &quot;, &quot;:&quot;);</span>

<span class="nc" id="L699">					System.out.println(&quot;[&quot; + keyValue + &quot;][&quot; + line + &quot;]&quot;);</span>

<span class="nc" id="L701">					String[] str = line.split(&quot;:&quot;);</span>

<span class="nc" id="L703">					System.out.println(str.length);</span>

<span class="nc bnc" id="L705" title="All 2 branches missed.">					for (int i = 1; i &lt; str.length; i++) {</span>

<span class="nc bnc" id="L707" title="All 2 branches missed.">						if (str[i].length() &gt; 0) {</span>

<span class="nc" id="L709">							logger.info(&quot;Pid的值：&quot; + str[i]);</span>

<span class="nc" id="L711">							list.add(str[i]);</span>

<span class="nc" id="L713">							break;</span>

						}

					}

<span class="nc" id="L719">				}</span>

			}

			// System.out.println(&quot;0表示正常终止：&quot; + process.waitFor());

<span class="nc" id="L725">			process.getOutputStream().close(); // 不要忘记了一定要关</span>

<span class="nc" id="L727">		} catch (Exception e) {</span>

<span class="nc" id="L729">			logger.error(&quot;获取应用程序列表异常&quot;, e);</span>

<span class="nc" id="L731">		}</span>

<span class="nc" id="L733">		logger.info(&quot;运行Dos命令......结束&quot;);</span>

<span class="nc" id="L735">	}</span>

	/**
	 * 运行Monkey命令
	 */
	class ThreadExcuteMonkey implements Runnable {

		private String[] cmd;

<span class="nc" id="L744">		public ThreadExcuteMonkey(String[] cmd) {</span>
<span class="nc" id="L745">			this.cmd = cmd;</span>
<span class="nc" id="L746">		}</span>

		public void run() {

			try {

<span class="nc" id="L752">				Runtime.getRuntime().exec(cmd);</span>

<span class="nc" id="L754">			} catch (Exception e) {</span>

<span class="nc" id="L756">				e.printStackTrace();</span>

<span class="nc" id="L758">			}</span>

<span class="nc" id="L760">		}</span>

	}

	/**
	 * 倒计时
	 * 
	 * @author Administrator
	 * 
	 */
	class ThreadExcuteTime implements Runnable {

		private long times;

<span class="nc" id="L774">		public ThreadExcuteTime(long times) {</span>
<span class="nc" id="L775">			this.times = times;</span>
<span class="nc" id="L776">		}</span>

		public void run() {

<span class="nc" id="L780">			long time = 1 * times; // 自定义倒计时时间</span>
<span class="nc" id="L781">			long hour = 0;</span>
<span class="nc" id="L782">			long minute = 0;</span>
<span class="nc" id="L783">			long seconds = 0;</span>

<span class="nc bnc" id="L785" title="All 2 branches missed.">			if (time &gt;= 0) {</span>

<span class="nc bnc" id="L787" title="All 2 branches missed.">				for (int i = 0; i &lt;= time; i++) {</span>

					//监控Monkey命令
<span class="nc" id="L790">					moniterMonkey(time, Common.Monkey);</span>

					//监控Monkey命令操作的App
<span class="nc" id="L793">					moniterApp(time, comboBoxProgram.getSelectedItem().toString());</span>

					//判断标识，是否中断操作
<span class="nc" id="L796">					System.out.println(&quot;flag==1?Interrupt:Continue:&quot; + flag);</span>

<span class="nc bnc" id="L798" title="All 2 branches missed.">					if (flag == 1) {</span>
<span class="nc" id="L799">						break;</span>
					}

<span class="nc" id="L802">					hour = time / 3600;</span>

<span class="nc" id="L804">					minute = (time - hour * 3600) / 60;</span>

<span class="nc" id="L806">					seconds = time - hour * 3600 - minute * 60;</span>

<span class="nc" id="L808">					labelHour.setText(hour + Common.Hour);</span>

<span class="nc" id="L810">					labelMinute.setText(minute + Common.Minute);</span>

<span class="nc" id="L812">					labelSecond.setText(seconds + Common.Second);</span>

					try {

<span class="nc" id="L816">						Thread.sleep(1000);</span>

<span class="nc" id="L818">					} catch (Exception e) {</span>

<span class="nc" id="L820">						e.printStackTrace();</span>

<span class="nc" id="L822">					}</span>

					//正常结束
<span class="nc bnc" id="L825" title="All 2 branches missed.">					if (time == 0) {</span>

<span class="nc" id="L827">						Thread.currentThread().interrupt();</span>

<span class="nc" id="L829">						interruptThread();</span>

<span class="nc" id="L831">						excuteButton.setEnabled(true);</span>
<span class="nc" id="L832">						resetButton.setEnabled(true);</span>
<span class="nc" id="L833">						interruptButton.setEnabled(false);</span>
<span class="nc" id="L834">						exitButton.setEnabled(true);</span>

					}

<span class="nc" id="L838">					i--;</span>

<span class="nc" id="L840">					time--;</span>

				}

<span class="nc bnc" id="L844" title="All 2 branches missed.">				if (flag == 1) {</span>

<span class="nc" id="L846">					Thread.currentThread().interrupt();</span>

<span class="nc" id="L848">					threadTimeType.interrupt();</span>

<span class="nc" id="L850">					excuteButton.setEnabled(true);</span>
<span class="nc" id="L851">					resetButton.setEnabled(true);</span>
<span class="nc" id="L852">					interruptButton.setEnabled(false);</span>
<span class="nc" id="L853">					exitButton.setEnabled(true);</span>

				}

			}

<span class="nc" id="L859">		}</span>

		/**
		 * 间隔60秒监控一次运行monkey命令是否为运行状态，或已关闭
		 * @param time	当前剩余执行时间
		 * @param keyValue	Monkey命令的进程名称
		 */
		public void moniterMonkey(long time, String keyValue) {

<span class="nc bnc" id="L868" title="All 2 branches missed.">			if ((time - 1) % 120 == 0) {</span>

<span class="nc" id="L870">				logger.info(&quot;监控[&quot; + keyValue + &quot;]线程是否执行完毕---开始&quot;);</span>

<span class="nc" id="L872">				logger.info(&quot;每60秒监听一次，此时time的值：&quot; + (time - 1));</span>

<span class="nc" id="L874">				String[] cmd = new String[] { &quot;cmd.exe&quot;, &quot;/c&quot;,</span>
<span class="nc" id="L875">						Common.CMD_PS_A + comboBoxDevices.getSelectedItem() + Common.CMD_PS_B };</span>
<span class="nc" id="L876">				logger.info(&quot;当前命令：&quot; + cmd[2]);</span>

<span class="nc" id="L878">				excuteCommand(cmd, keyValue);</span>

<span class="nc" id="L880">				logger.info(&quot;当前线程数：&quot; + list.size());</span>

<span class="nc bnc" id="L882" title="All 2 branches missed.">				if (list.size() == 0) {</span>

<span class="nc" id="L884">					String log = textLogPath.getText();</span>

<span class="nc" id="L886">					System.out.println(textLogPath.getText());</span>

<span class="nc" id="L888">					String getDate = Utils.getCurrentDateString();</span>

					// 日志文件路径
<span class="nc" id="L891">					String logFile = log.substring(0, log.indexOf(&quot;java_monkey_log&quot;)) + Common.Log_name + getDate</span>
							+ &quot;.txt&quot;;

<span class="nc" id="L894">					textLogPath.setText(logFile);</span>

<span class="nc" id="L896">					System.out.println(&quot;monkeyCmd[2];&quot; + monkeyCmd[2]);</span>

<span class="nc" id="L898">					monkeyCmd[2] = monkeyCmd[2].substring(0, monkeyCmd[2].indexOf(&quot;java_monkey_log&quot;))</span>
							+ &quot;java_monkey_log&quot; + getDate + &quot;.txt&quot;;

<span class="nc" id="L901">					logger.info(&quot;Monkey命令已经停止，再次执行&quot;);</span>
<span class="nc" id="L902">					logger.info(&quot;monkeyCmd[2];&quot; + monkeyCmd[2]);</span>

<span class="nc" id="L904">					String[] monkeyCommand = new String[] { &quot;cmd.exe&quot;, &quot;/c&quot;, monkeyCmd[2] };</span>

<span class="nc" id="L906">					logger.info(&quot;执行&quot;);</span>

					// 再次执行
<span class="nc" id="L909">					threadMonkey = new Thread(new ThreadExcuteMonkey(monkeyCommand));</span>
<span class="nc" id="L910">					threadMonkey.start();</span>

				}

<span class="nc" id="L914">				logger.info(&quot;监控[&quot; + keyValue + &quot;]线程是否执行完毕---结束&quot;);</span>

			}

<span class="nc" id="L918">		}</span>

		/**
		 * 间隔60秒监控一次运行app是否是启动状态，或崩溃掉
		 * @param time	当前剩余执行时间
		 * @param keyValue	App的进程名称
		 */
		public void moniterApp(long time, String keyValue) {

<span class="nc bnc" id="L927" title="All 2 branches missed.">			if ((time - 1) % 120 == 0) {</span>

<span class="nc" id="L929">				logger.info(&quot;监控[&quot; + keyValue + &quot;]线程是否执行完毕---开始&quot;);</span>

<span class="nc" id="L931">				logger.info(&quot;每60秒监听一次，此时time的值：&quot; + (time - 1));</span>

<span class="nc" id="L933">				String[] cmd = new String[] { &quot;cmd.exe&quot;, &quot;/c&quot;,</span>
<span class="nc" id="L934">						Common.CMD_PS_A + comboBoxDevices.getSelectedItem() + Common.CMD_PS_B };</span>
<span class="nc" id="L935">				logger.info(&quot;当前命令：&quot; + cmd[2]);</span>

<span class="nc" id="L937">				excuteCommand(cmd, keyValue);</span>

<span class="nc" id="L939">				logger.info(&quot;当前线程数：&quot; + list.size());</span>

<span class="nc bnc" id="L941" title="All 2 branches missed.">				if (list.size() == 0) {</span>

<span class="nc" id="L943">					logger.info(&quot;[&quot; + keyValue + &quot;]已经关闭或崩溃，无法继续执行Monkey，退出系统&quot;);</span>

<span class="nc" id="L945">					logger.info(&quot;监控[&quot; + keyValue + &quot;]线程是否执行完毕---结束&quot;);</span>

					// 杀掉Monkey执行进程
<span class="nc" id="L948">					interruptThread();</span>

<span class="nc" id="L950">					System.gc();</span>

					//退出系统
<span class="nc" id="L953">					System.exit(0);</span>

				}

<span class="nc" id="L957">				logger.info(&quot;监控[&quot; + keyValue + &quot;]线程是否执行完毕---结束&quot;);</span>

			}

<span class="nc" id="L961">		}</span>

	}

	/**
	 * 执行提示Dialog
	 * 
	 * @author Administrator
	 * 
	 */
	class Dialog1 extends JDialog {

		private static final long serialVersionUID = 1L;

<span class="nc" id="L975">		JDialog dialog1 = new JDialog(this, &quot;JDialog窗体&quot;, true);</span>

		// dialog.setUndecorated(true);

<span class="nc" id="L979">		Dialog1(String msg) {</span>

<span class="nc" id="L981">			dialog1.setSize(320, 180);</span>

<span class="nc" id="L983">			Container container = dialog1.getContentPane();</span>

<span class="nc" id="L985">			container.setLayout(null);</span>

<span class="nc" id="L987">			JLabel jl = new JLabel(msg);</span>

<span class="nc" id="L989">			jl.setBounds(110, 1, 100, 100);</span>

<span class="nc" id="L991">			JButton jbb = new JButton(&quot;确    定&quot;);</span>

<span class="nc" id="L993">			jbb.setBounds(97, 80, 100, 25);</span>

<span class="nc" id="L995">			container.add(jl);</span>

<span class="nc" id="L997">			container.add(jbb);</span>

			// 设置位置
<span class="nc" id="L1000">			int w = (Toolkit.getDefaultToolkit().getScreenSize().width - 320) / 2;</span>
<span class="nc" id="L1001">			int h = (Toolkit.getDefaultToolkit().getScreenSize().height - 180) / 2;</span>

<span class="nc" id="L1003">			dialog1.setLocation(w, h);</span>

<span class="nc" id="L1005">			jbb.addActionListener(new ActionListener() {</span>

				public void actionPerformed(ActionEvent e) {
					// dialog.dispose();

<span class="nc" id="L1010">					logger.info(&quot;Already Closed&quot;);</span>

<span class="nc" id="L1012">					System.exit(0);</span>
<span class="nc" id="L1013">				}</span>

			});

<span class="nc" id="L1017">			dialog1.setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);</span>

<span class="nc" id="L1019">		}</span>

	}

	/**
	 * 执行提示Dialog
	 * 
	 * @author Administrator
	 * 
	 */
	class Dialog2 extends JDialog {

		private static final long serialVersionUID = 1L;

<span class="nc" id="L1033">		JDialog dialog2 = new JDialog(this, &quot;JDialog窗体&quot;, true);</span>

<span class="nc" id="L1035">		Dialog2(String msg3) {</span>

<span class="nc" id="L1037">			dialog2.setSize(320, 180);</span>

<span class="nc" id="L1039">			Container container = dialog2.getContentPane();</span>

<span class="nc" id="L1041">			container.setLayout(null);</span>

<span class="nc" id="L1043">			JLabel jl = new JLabel(msg3);</span>

<span class="nc" id="L1045">			jl.setBounds(70, 1, 200, 100);</span>

<span class="nc" id="L1047">			JButton jbb = new JButton(&quot;确    定&quot;);</span>

<span class="nc" id="L1049">			jbb.setBounds(97, 80, 100, 25);</span>

<span class="nc" id="L1051">			container.add(jl);</span>

<span class="nc" id="L1053">			container.add(jbb);</span>

			// 设置位置
<span class="nc" id="L1056">			int w = (Toolkit.getDefaultToolkit().getScreenSize().width - 320) / 2;</span>
<span class="nc" id="L1057">			int h = (Toolkit.getDefaultToolkit().getScreenSize().height - 180) / 2;</span>

<span class="nc" id="L1059">			dialog2.setLocation(w, h);</span>

<span class="nc" id="L1061">			jbb.addActionListener(new ActionListener() {</span>

				public void actionPerformed(ActionEvent e) {

<span class="nc" id="L1065">					dialog2.dispose();</span>

<span class="nc" id="L1067">				}</span>

			});

<span class="nc" id="L1071">			dialog2.setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);</span>

<span class="nc" id="L1073">		}</span>

	}

	/**
	 * 执行提示Dialog
	 * 
	 * @author Administrator
	 * 
	 */
	class Dialog3 extends JDialog {

		private static final long serialVersionUID = 1L;

<span class="nc" id="L1087">		JDialog dialog3 = new JDialog(this, &quot;JDialog窗体&quot;, true);</span>

<span class="nc" id="L1089">		Dialog3(String msg4) {</span>

<span class="nc" id="L1091">			dialog3.setSize(320, 180);</span>

<span class="nc" id="L1093">			Container container = dialog3.getContentPane();</span>

<span class="nc" id="L1095">			container.setLayout(null);</span>

<span class="nc" id="L1097">			JLabel jl = new JLabel(msg4);</span>

<span class="nc" id="L1099">			jl.setBounds(70, 1, 200, 100);</span>

<span class="nc" id="L1101">			JButton jbb = new JButton(&quot;确    定&quot;);</span>

<span class="nc" id="L1103">			jbb.setBounds(97, 80, 100, 25);</span>

<span class="nc" id="L1105">			container.add(jl);</span>

<span class="nc" id="L1107">			container.add(jbb);</span>

			// 设置位置
<span class="nc" id="L1110">			int w = (Toolkit.getDefaultToolkit().getScreenSize().width - 320) / 2;</span>
<span class="nc" id="L1111">			int h = (Toolkit.getDefaultToolkit().getScreenSize().height - 180) / 2;</span>

<span class="nc" id="L1113">			dialog3.setLocation(w, h);</span>

<span class="nc" id="L1115">			jbb.addActionListener(new ActionListener() {</span>

				public void actionPerformed(ActionEvent e) {

<span class="nc" id="L1119">					dialog3.dispose();</span>

<span class="nc" id="L1121">				}</span>

			});

<span class="nc" id="L1125">			dialog3.setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);</span>

<span class="nc" id="L1127">		}</span>

	}

}


/**
 * 自动完成器。自动找到最匹配的项目，并排在列表的最前面。
 */
class AutoCompleter3 implements KeyListener, ItemListener {

<span class="nc" id="L1139">	private JComboBox owner = null;</span>
<span class="nc" id="L1140">	private JTextField editor = null;</span>
<span class="nc" id="L1141">	private ComboBoxModel model = null;</span>

<span class="nc" id="L1143">	public AutoCompleter3(JComboBox comboBox) {</span>
<span class="nc" id="L1144">		owner = comboBox;</span>
<span class="nc" id="L1145">		editor = (JTextField) comboBox.getEditor().getEditorComponent();</span>
<span class="nc" id="L1146">		editor.addKeyListener(this);</span>

		// 返回 JComboBox 当前使用的数据模型，也就是获取下拉列表个数
<span class="nc" id="L1149">		model = comboBox.getModel();</span>

<span class="nc" id="L1151">		owner.addItemListener(this);</span>
<span class="nc" id="L1152">	}</span>

	public void keyTyped(KeyEvent e) {
<span class="nc" id="L1155">	}</span>

	public void keyPressed(KeyEvent e) {
<span class="nc" id="L1158">	}</span>

	public void keyReleased(KeyEvent e) {
<span class="nc" id="L1161">		char ch = e.getKeyChar();</span>
<span class="nc bnc" id="L1162" title="All 6 branches missed.">		if (ch == KeyEvent.CHAR_UNDEFINED || Character.isISOControl(ch)</span>
				|| ch == KeyEvent.VK_DELETE)
<span class="nc" id="L1164">			return;</span>

		// 返回文本组件的文本插入符的位置
<span class="nc" id="L1167">		int caretPosition = editor.getCaretPosition();</span>

		// 返回此 TextComponent 中包含的文本
<span class="nc" id="L1170">		String str = editor.getText();</span>

<span class="nc" id="L1172">		System.out.println(&quot;str&quot; + str);</span>
<span class="nc" id="L1173">		System.out.println(&quot;car&quot; + caretPosition);</span>

<span class="nc bnc" id="L1175" title="All 2 branches missed.">		if (str.length() == 0)</span>
<span class="nc" id="L1176">			return;</span>
<span class="nc" id="L1177">		autoComplete(str, caretPosition);</span>
<span class="nc" id="L1178">	}</span>

	/**
	 * 自动完成。根据输入的内容，在列表中找到相似的项目.
	 */
	protected void autoComplete(String strf, int caretPosition) {

		Object[] opts;

<span class="nc" id="L1187">		opts = getMatchingOptions(strf.substring(0, caretPosition));</span>

		// 给owner赋值
<span class="nc bnc" id="L1190" title="All 2 branches missed.">		if (owner != null) {</span>

<span class="nc" id="L1192">			model = new DefaultComboBoxModel(opts);</span>

			// 设置 JComboBox 用于获取项列表的数据模型
<span class="nc" id="L1195">			owner.setModel(model);</span>

		}

<span class="nc bnc" id="L1199" title="All 2 branches missed.">		if (opts.length &gt; 0) {</span>

			// 设置 TextComponent 的文本插入符的位置
<span class="nc" id="L1202">			editor.setCaretPosition(caretPosition);</span>

<span class="nc bnc" id="L1204" title="All 2 branches missed.">			if (owner != null) {</span>

				try {

					// 促使组合框显示其弹出窗口
<span class="nc" id="L1209">					owner.showPopup();</span>

<span class="nc" id="L1211">				} catch (Exception ex) {</span>

<span class="nc" id="L1213">					ex.printStackTrace();</span>

<span class="nc" id="L1215">				}</span>

			}

		}

<span class="nc" id="L1221">	}</span>

	/**
	 * 
	 * 找到相似的项目, 并且将之排列到数组的最前面。
	 * 
	 * @param str
	 * @return 返回所有项目的列表。
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	protected Object[] getMatchingOptions(String str) {

<span class="nc" id="L1233">		System.out.println(&quot;substr:&quot; + str);</span>

<span class="nc" id="L1235">		List v = new Vector();</span>
<span class="nc" id="L1236">		List v1 = new Vector();</span>

<span class="nc" id="L1238">		System.out.println(&quot;modelSize:&quot; + model.getSize());</span>

<span class="nc bnc" id="L1240" title="All 2 branches missed.">		for (int k = 0; k &lt; model.getSize(); k++) {</span>

			// 返回指定索引处的值
<span class="nc" id="L1243">			Object itemObj = model.getElementAt(k);</span>

<span class="nc bnc" id="L1245" title="All 2 branches missed.">			if (itemObj != null) {</span>

<span class="nc" id="L1247">				String item = itemObj.toString().toLowerCase();</span>

				// 测试此字符串是否以指定的前缀开始
<span class="nc bnc" id="L1250" title="All 2 branches missed.">				if (item.startsWith(str.toLowerCase())) {</span>
<span class="nc" id="L1251">					System.out.println(&quot;v前缀开始&quot;</span>
<span class="nc" id="L1252">							+ item.startsWith(str.toLowerCase()));</span>
<span class="nc" id="L1253">					v.add(itemObj);</span>

				} else {
<span class="nc" id="L1256">					System.out.println(&quot;v1前缀开始&quot;</span>
<span class="nc" id="L1257">							+ item.startsWith(str.toLowerCase()));</span>
<span class="nc" id="L1258">					v1.add(itemObj);</span>
				}
<span class="nc" id="L1260">			} else {</span>

<span class="nc" id="L1262">				System.out.println(&quot;下拉框有null数据&quot;);</span>
<span class="nc" id="L1263">				v1.add(itemObj);</span>
			}
		}

<span class="nc" id="L1267">		System.out.println(&quot;v1.size():&quot; + v1.size());</span>

		// 这样循环写的目的是将数据在数组中按顺序排序，符合条件在头，不符合在后
<span class="nc bnc" id="L1270" title="All 2 branches missed.">		for (int i = 0; i &lt; v1.size(); i++) {</span>

<span class="nc" id="L1272">			v.add(v1.get(i));</span>

		}

<span class="nc bnc" id="L1276" title="All 2 branches missed.">		if (v.isEmpty())</span>

<span class="nc" id="L1278">			v.add(str);</span>

<span class="nc" id="L1280">		System.out.println(&quot;v.size():&quot; + v.size());</span>

<span class="nc" id="L1282">		return v.toArray();</span>

	}

	public void itemStateChanged(ItemEvent event) {

<span class="nc bnc" id="L1288" title="All 2 branches missed.">		if (event.getStateChange() == ItemEvent.SELECTED) {</span>

<span class="nc" id="L1290">			int caretPosition = editor.getCaretPosition();</span>

<span class="nc bnc" id="L1292" title="All 2 branches missed.">			if (caretPosition != -1) {</span>

				try {

<span class="nc" id="L1296">					editor.moveCaretPosition(caretPosition);</span>

<span class="nc" id="L1298">				} catch (IllegalArgumentException ex) {</span>

<span class="nc" id="L1300">					ex.printStackTrace();</span>

<span class="nc" id="L1302">				}</span>

			}

		}

<span class="nc" id="L1308">	}</span>

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>